#!/bin/bash

# NOTE: to use this file, install bud first: https://github.com/dohsimpson/bud
# then run: `bud help`

APP_DIR=apps/web

help() {
  echo "TaskTrove Dev Script"
  echo ""
  echo "Commands:"
  echo "  dev                 Start dev server"
  echo "  run <script>        Run pnpm script"
  echo "  docker-build [tag]  Build multi-platform Docker image (AMD64/ARM64)"
}

dev() {
  pnpm dev
}

run() {
  if [ -z "$1" ]; then
    echo "Usage: bud run <script>"
    return 1
  fi
  pnpm run "$1"
}

docker-build() {
  local tag="${1:-ghcr.io/dohsimpson/tasktrove:latest}"
  echo "Building multi-platform Docker image: $tag"
  echo "Platforms: linux/amd64, linux/arm64"
  
  # Build multi-platform image using default builder
  docker buildx build \
    --platform linux/amd64,linux/arm64 \
    --tag "$tag" \
    --output type=docker \
    -f "$APP_DIR"/Dockerfile \
    .
}

docker-push() {
  local tag="${1:-ghcr.io/dohsimpson/tasktrove:latest}"
  docker push "$tag"
}

docker-run() {
  docker run -it --rm -p 3000:3000 -v ${APP_DIR}/data:/app/data ghcr.io/dohsimpson/tasktrove
}

rollout() {
  kubie exec k3s unsafe kubectl rollout restart deployment tasktrove-demo
}

_stash_and_rebase_and_pnpm_install() {
  git stash
  git rebase "$1"
  pnpm install
}

# Show help when no arguments are provided
if [ $# -eq 0 ]; then
  help
fi
